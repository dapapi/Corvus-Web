<template>
    <span>
        <span v-if="type === 'export'" @click="exportFile">
            <slot></slot>
        </span>
        <span v-if="type === 'import'">
            <form action="" style="display:inline-block">
                <input type="file" :id="`import_${this.getRandom}`" name="avatar" style="display:none" @change="importFile($event)">
                <label :for="`import_${this.getRandom}`">
                <slot></slot>
                </label>
            </form>
            
        </span>
    </span>
</template>
<script>
import axios from 'axios'

import config from '../assets/js/config'
import fetch from '../assets/utils/fetch.js'
//导入和导出调通的模块只有 客户
export default {
    name:'ImportAndExport',
    props:{
        //模块名称
        moduleName:{
            type:String,
            required:true,
        },
        //import 导入 export 导出
        type:{
            type:String,
            required:true
        }
    },
    data(){
        return {
          getRandom:Math.round(Math.random() * 1000),
          file:'',
          header:config.getHeaders()
        }
    },
    mounted(){
    //    console.log(config.getHeaders())
    },
    methods:{
        
        importFile:function(event){

            // let dom = document.getElementById(`import_${this.getRandom}`)
            console.log(this.header)
            this.header['Content-Type'] = 'multipart/form-data;boundary = ' + new Date().getTime()
            this.file = event.target.files[0];
            let importUrl = `${config.apiUrl}/${this.moduleName}/import`
            let formData = new FormData();
            
            // let blob = new Blob([event.target.files[0]], {type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=utf-8'})
            formData.append('file', this.file);
            console.log(event.target.files[0])
            // console.log(formData.getAll('file'))
            var instance = axios.create();
            instance.defaults.headers = this.header
            instance.post(importUrl, formData)
            .then(function (response) {
                console.log(response);
            })
            .catch(function (error) {
                console.log(error);
            });
            
        },
        exportFile:function(){
            var xhh = new XMLHttpRequest();
            var page_url = `${config.apiUrl}/${this.moduleName}/export`
            xhh.open("GET", page_url)
            xhh.setRequestHeader('Accept', 'application/vnd.Corvus.v1+json')
            xhh.setRequestHeader('Authorization', `Bearer ${config.getAccessToken() || ''}`)
            xhh.responseType = 'blob'
            xhh.onreadystatechange = function () {
                if (xhh.readyState === 4 && xhh.status === 200) {
                    var filename = xhh.getResponseHeader("Content-disposition")
                        filename = decodeURI(filename)
                        filename = filename.split("filename*=utf-8''")[1]
                    var blob = new Blob([xhh.response], {type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=utf-8'})
                    var csvUrl = URL.createObjectURL(blob)
                    var link = document.createElement('a')
                    link.href = csvUrl
                    link.download = filename
                    link.click()
                }
            };
            xhh.send();
        }
    }
}
</script>

