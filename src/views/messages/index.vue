<template>
   <div class="page-main" style="background-color:#f3f4f5">
        <div class="page-header page-header-bordered clearfix">
            <h1 class="page-title float-left">我的消息</h1>
            <div class="filter-container float-right" >
                <div class="text-right mark-all-read">
                    <i class="icon md-circle-o" v-show="readFilter && messageList" data-target="#confirmFlag" 
                    data-toggle="modal"></i>&nbsp;
                    <span v-show="readFilter && messageList" 
                    data-target="#confirmFlag" 
                    data-toggle="modal">全部标记为已读</span> 
                </div>
            </div>
        </div>
        <div class="page-content container-fluid" >
            <div class="row mx-0" style="background-color:#fff">
                <div class="col-md-2">
                 <div class="list-group mt-20" style="border-right:1px solid #E0E0E0">
                    <a :class="item.id == moduleType?'checked list-group-item mr-10':'list-group-item mr-10'" v-for="(item,index) in moduleList" :key="index" href="javascript:void(0)" role="menuitem" @click="renderMsg(item.id,state)">{{item.name}}<span v-show="item.un_read>0" class="unRead ml-5">{{item.un_read}}</span></a>
                </div>
            </div>
            <div class="col-md-10 py-5">
                <div class="col-md-12">
                    <ul class="nav nav-tabs nav-tabs-line" role="tablist">
                        <li class="nav-item" role="presentation" >
                            <a class="nav-link active" data-toggle="tab" href="#forum-task"
                                aria-controls="forum-base"
                                aria-expanded="true" role="tab" @click='renderMsg(moduleType,1)'>未读</a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" data-toggle="tab" href="#forum-task"
                                aria-controls="forum-present"
                                aria-expanded="false" role="tab" @click='renderMsg(moduleType,2)'>已读</a>
                        </li>
                    </ul>
                </div>
                <div class="page-content tab-content nav-tabs-animate bg-white">
                    <div class="pt-10 list">
                        <!--list-->
                        <div class="message" :class="moduleType" v-for="(item, key) in messageList" :key="key" @click="messageClickHandler(index)">
                            <div class="time_line">
                                <span class="time_con bg-white font-size-18">{{key}} 星期{{week.find(item => item.value == new Date(key).getDay()).name}}</span>
                            </div>
                            <ul class="list mt-40 ml-0 pl-0">
                                <li class="row mb-30" v-for="(item2,index2) in item" :key="index2">
                                    <!-- <router-link :to="item.url"> -->
                                        <div class="clearfix col-md-12 module">
                                            <div class="float-left mr-10 pic">
                                                <i class="icon  font-size-30 icon-color" :class="iconList[moduleType]"></i>
                                            </div>
                                            <div class="float-left mb-10">
                                                <p class="mb-5"><span class="module_title mr-5 title">{{moduleList[moduleType]}}助手</span><i class="timesR">{{item2.created_at.split(' ')[1]}}</i></p>
                                                <p class="desc txt font-size-16">{{item2.message_title}}</p>
                                            </div>
                                        </div>
                                        <div class="content py-15 pl-40 col-md-8 ml-80">
                                                <span class="is_read" v-show="item2.state == 1"></span>
                                                <div class="title font-size-16 mb-15">孙誉倬-加班</div>
                                                <div class="row">
                                                     <div class="col-md-4" v-for="(item3,index3) in item2.body" :key="index3">
                                                         <div class="mb-5">{{item3.title}}</div>
                                                         <div>{{item3.value}}</div>
                                                     </div>
                                                </div>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                        </div>
                                    <!-- </router-link> -->
                                </li>
                            </ul>
                        </div>
                        <div v-if="messageList.length === 0" class="col-md-1" style="margin: 6rem auto">
                                <img src="https://res.papitube.com/corvus/images/content-none.png" alt="" style="width: 100%">
                        </div>
                        <!--list-->
                    </div>
                </div>
            </div>
            </div>
        </div>
        <Flag typeText="全部标记为已读" @confirmFlag='emitMarkasRead'/>
    </div>
</template>

<script>
import Main from './detail.vue';
import messagesData from './messages.json'
import fetch from '@/assets/utils/fetch'
import config from '@/assets/js/config'

export default {
  name: 'messagesIndex',
  components: {
    Main,
  },
  data() {
    return {
      messageStatus: null,      //消息状态
      readTypeShow: false,      //全部消息列表展开控制
      pageData:{},              //页面数据
      readFilter:true,          //阅读状态筛选
      messageFilter:"全部消息",   //消息过滤器状态
      moduleList:{},//模块list
      moduleType:'',
      messageList:[],//消息list
      iconList:{//每个模块的icon
        announcement: "md-time",
        attendance: "md-time",
        blogger: "md-time",
        calendar: "md-time",
        client: "md-time",
        contact: "md-time",
        department: "md-time",
        groupRoles: "md-time",
        issues: "md-time",
        personalJob: "md-time",
        personalSalary: "md-time",
        project: "md-layers",
        report: "md-time",
        role: "md-time",
        schedule: "md-time",
        star: "md-time",
        task: "md-flag",
        trail: "md-time",
        user: "md-time",
        work: "md-time"
      },
      week:config.week,
      state:1,// 1未读 2已读
    };
  },
  mounted() {
      //数据初始化
    //   this.dataInit()
      this.getModule()
      this.receive()
      
  },
  computed:{      
  },
  methods: {
    
    receive:function(){
            let login = {}
            let user = JSON.parse(Cookies.get('user'))
            login.username = user.nickname
            login.userId = user.id
            login.authorization = 'Bearer ' + config.getAccessToken() || ''
            // console.log(login.username,login.userId)
            login.action = "login"
            // 初始化一个 WebSocket 对象
            var ws = new WebSocket(config.socketUrl);
            
            // 建立 web socket 连接成功触发事件
            ws.onopen = function () {
            // 使用 send() 方法发送数据
            ws.send(JSON.stringify(login));
            // console.log(login)
            console.log("数据发送中...");
            };

            // 接收服务端数据时触发事件
            ws.onmessage = function (evt) {
                console.log(evt)
            var received_msg = evt.data;
            // console.log("数据已接收...");
            // console.log(evt.data)
            alert(received_msg)
            let msg = eval("'" + evt.data + "'")
            console.log(typeof msg)
            // msg = JSON.parse(msg)
            toastr.success(msg.title)
            // console.log(msg.title)
            // console.log(typeof msg)
        
        };
    },

    renderMsg:function(type,state){
        // console.log(type,state)
        if(type){
            this.moduleType = type
        }
        if(state ==1){
            this.state = state
            this.readFilter = true
        }else{
            this.state = state
            this.readFilter = false
        }
        
        fetch('get',`${config.apiUrl}/getmsg?include=recive.data&module=${this.moduleType}&state=${this.state}`).then((res) => {
            this.messageList = res.data
            // console.log(this.readFilter,this.messageList.length)

        })
    },
    getModule:function(){
        fetch('get',`${config.apiUrl}/getmodules`).then((res) => {
            this.moduleList = res
            // this.moduleType = this.moduleList[0]
            this.renderMsg(this.moduleList[0].id,1)
        })
    },
    //消息模式变更
    // readTypeToggle() {
    //   this.readTypeShow = !this.readTypeShow;
    // },
    //消息状态变更
    // messageStatusChange(ref) {
    //   this.messageStatus = ref;
    // },
    //初始化数据
    // dataInit(){
    //     for (const key in messagesData) {
    //         let orignTime = messagesData[key].time
    //         messagesData[key].timeYMD = this.timeFormat(orignTime).formatYMD
    //         messagesData[key].timehms = this.timeFormat(orignTime).formathms
    //     }
    //     this.pageData = messagesData
    // },
    //日期格式化
    // timeFormat(ref){
    //     let date = new Date(ref);
    //     let Y = date.getFullYear()
    //     let M = (date.getMonth()+1 < 10 ? '0'+(date.getMonth()+1) : date.getMonth()+1)
    //     let D = date.getDate()
    //     let h = date.getHours()
    //     let m = (date.getMinutes() < 10 ? '0'+(date.getMinutes()):date.getMinutes())
    //     let s = (date.getSeconds()<10?'0'+(date.getSeconds()):date.getSeconds())
    //     let formatYMD = Y+'-'+M+'-'+D
    //     let formathms = h+':'+m+':'+s
    //     return{
    //         formatYMD,formathms
    //     }
    // },
    //已读、未读控制器
    messageClickHandler(ref){
        this.pageData[ref].readflag = false
    },
    //全部消息已读接收器
    emitMarkasRead(){
        for (const key in this.pageData) {
            this.pageData[key].readflag = false
        }
    },
    //设置当前消息为未读
    // markAsUnread(ref){
    //     for (const key in this.pageData) {
    //         if(this.pageData[key].messageid == ref) {
    //             this.pageData[key].readflag = true
    //         }
    //     }
    // },
    messageFilterHandler(ref){
        this.messageFilter = ref
    }
  },
};
</script>

<style lang="scss" scoped>

.message{
    .time_line{
        border-bottom:1px dashed #CECECE;

        span{
            position: relative;
            bottom:-15px;
            display: inline-block;
            padding-right:10px

        } 
        
    }
    .module{
        i{
            font-style: normal
        }
    }
    .content{
        position: relative;
        color:#999
    }
    .is_read{
        display: inline-block;
        position: absolute;
        top:0px;
        right: 0px;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background-color: #F44336;
    }
    .txt{
        color:#999
    }
    .title{
        color:#333
    }
    .icon-color{
        color:#fff
    }
    .pic{
        
        width: 50px;
        height: 50px;
        border-radius: 50%;
        text-align: center;
        padding-top:10px;
    }
    
}
.unRead{
    display: inline-block;
    width: 18px;
    height: 18px;
    background-color:red;
    color:#fff;
    font-size: 12px;
    font-weight: bold;
    text-align: center;
    line-height: 18px;
    border-radius: 50%;
}
.checked{
    background-color:#eee
}
.announcement{
    .pic{
        background-color:#B53FAF
    }
    .content{
        background:rgba(181,63,175,0.02);
        border-left:2px solid #B53FAF;
    }
    
}
.project{
    .pic{
        background-color:#536DFE
    }
    .content{
        background:rgba(83,109,254,0.02);
        border-left:2px solid #536DFE;
    }
    
}
.star{
    .pic{
        background-color:#A953FE
    }
    .content{
        background:rgba(169,83,254,0.02);
        border-left:2px solid #A953FE;
    }
    
}
.trail{
    
    .pic{
        background-color:#E040FB
    }
    .content{
        background:rgba(224,64,251,0.02);
        border-left:2px solid #E040FB;
    }
}

.task{
    
    .pic{
        background-color:#448aff
    }
    .content{
        background:rgba(68,138,255,0.02);
        border-left:2px solid #448aff;
    }
}
.calendar{
    
    .pic{
        background-color:#FF6F3F
    }
    .content{
        background:rgba(255,111,63,0.02);
        border-left:2px solid #FF6F3F;
    }
}
.personalJob{
    
    .pic{
        background-color:#3F51B5
    }
    .content{
        background:rgba(63,81,181,0.02);
        border-left:2px solid #3F51B5;
    }
}
.filter-container{
    display: inline-block;
    cursor: pointer;
    font-family: PingFangSC-Regular;
    font-size: 14px;
    color: #333333;
    letter-spacing: 0;
    user-select: none; 
    margin-top: 5px;

}
.dropdown{
    margin-left: 20px;
    display: inline-block;
}
.mark-all-read{
    position: absolute;
    right: 41px;
    top: 31px;
}
.message-main-container>:first-child:hover{
    background: rgba(87, 140, 242, 0.14);
}
.messages-date{
    font-family: PingFangSC-Regular;
    font-size: 18px;
    color: #C4C4C4;
    letter-spacing: 0;
}
li{
    list-style-type: none;
}
</style>
